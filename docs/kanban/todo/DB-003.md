# [DB-003] Indexes and Materialized Views Creation

## Metadata
- **Status**: TODO
- **Priority**: High
- **Assignee**: TBD
- **Estimated Time**: 8 hours
- **Sprint**: Sprint 1 (Week 1-2)
- **Tags**: #database #performance #optimization

## Description
Create indexes for query performance optimization and materialized views to optimize complex join queries.

## Subtasks
- [ ] Create and execute 03_indexes.sql
  - [ ] stocks table indexes
    - [ ] idx_stocks_market (partial index on active stocks)
    - [ ] idx_stocks_sector (partial index on active stocks)
    - [ ] idx_stocks_name_trgm (trigram index for fuzzy search)
  - [ ] daily_prices table indexes
    - [ ] idx_prices_date_range (stock_code, trade_date DESC)
  - [ ] calculated_indicators table indexes
    - [ ] idx_indicators_date (calculation_date DESC)
    - [ ] idx_indicators_per (per) WHERE per IS NOT NULL
    - [ ] idx_indicators_pbr (pbr) WHERE pbr IS NOT NULL
    - [ ] idx_indicators_roe (roe) WHERE roe IS NOT NULL
    - [ ] idx_indicators_scores (quality_score, value_score, growth_score)
  - [ ] users table indexes
    - [ ] idx_users_email (UNIQUE)
  - [ ] alerts table indexes
    - [ ] idx_alerts_user_active (user_id) WHERE is_active = true
- [ ] Create and execute 05_views.sql
  - [ ] stock_screening_view (Materialized View)
    - [ ] JOIN latest price + latest indicators
    - [ ] Include only active stocks
  - [ ] daily_prices_weekly (Continuous Aggregate)
  - [ ] daily_prices_monthly (Continuous Aggregate)
  - [ ] sector_performance (Materialized View)
- [ ] Create view refresh functions
  - [ ] refresh_all_materialized_views()
  - [ ] refresh_screening_view()
- [ ] Write index usage monitoring queries

## Acceptance Criteria
- [ ] All indexes created successfully: `SELECT indexname FROM pg_indexes WHERE schemaname = 'public';`
- [ ] Materialized views created: `SELECT matviewname FROM pg_matviews;`
- [ ] stock_screening_view SELECT query < 100ms
- [ ] EXPLAIN ANALYZE results confirm index scan usage
- [ ] Index size verified: `SELECT pg_size_pretty(pg_total_relation_size('index_name'));`
- [ ] REFRESH CONCURRENTLY succeeds for materialized views
- [ ] Fuzzy search test succeeds: `SELECT * FROM stocks WHERE name % 'samsung';`

## Dependencies
- **Depends on**: DB-002
- **Blocks**: BE-003, BE-004

## References
- **SDS.md**: Section 4.3 Materialized Views, Section 4.5 Query Optimization
- **database/migrations/03_indexes.sql**
- **database/migrations/05_views.sql**
- [PostgreSQL Index Types](https://www.postgresql.org/docs/16/indexes-types.html)
- [TimescaleDB Continuous Aggregates](https://docs.timescale.com/use-timescale/latest/continuous-aggregates/)

## Progress
- **0%** - Not started

## Notes
- Use partial indexes to reduce index size (WHERE delisting_date IS NULL)
- Materialized views MUST use CONCURRENTLY refresh (prevent locking)
- Monitor index usage after data accumulation (remove unused indexes)
