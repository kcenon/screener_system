# DOC-006: CI/CD Documentation Build & GitHub Pages Deployment

## Metadata
- **Type**: Documentation Infrastructure
- **Priority**: High
- **Status**: TODO
- **Created**: 2025-11-12
- **Assignee**: TBD
- **Estimate**: 5 hours
- **Sprint**: Documentation Sprint 2
- **Dependencies**: DOC-001, DOC-002, DOC-003

## Description

Integrate documentation building and automatic deployment to GitHub Pages via CI/CD pipeline. Ensure docs are always up-to-date, validated, and automatically deployed on every commit to main branch.

## Requirements

### Build Pipeline

**On Push to Main Branch**:
- Build Sphinx documentation (Python API)
- Build TypeDoc documentation (TypeScript API)
- Build Docusaurus site (main platform)
- Validate build integrity
- Deploy to GitHub Pages (gh-pages branch)
- Documentation live at docs.screener.kr within 5 minutes

### Quality Gates
- [ ] Documentation builds successfully without errors
- [ ] All build steps complete in < 3 minutes
- [ ] GitHub Pages deployment succeeds
- [ ] Site accessible at custom domain
- [ ] HTTPS enforced with valid certificate

## Tasks

### Phase 1: GitHub Actions Workflow Setup (2 hours)

Create `.github/workflows/docs.yml`:

```yaml
name: Deploy Documentation to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'frontend/src/**'
      - 'backend/app/**'
      - 'docs-site/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Required for gh-pages deployment

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'docs-site/package-lock.json'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install -r requirements-docs.txt

      - name: Build Sphinx documentation
        run: |
          cd docs/api/python
          sphinx-build -b html . ../../_build/api/backend

      - name: Build TypeDoc documentation
        run: |
          cd docs-site
          npm ci
          npx typedoc

      - name: Build Docusaurus site
        run: |
          cd docs-site
          npm run build
        env:
          NODE_ENV: production

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs-site/build
          cname: docs.screener.kr
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'docs: deploy documentation [skip ci]'
```

**Tasks**:
- [ ] Create workflow file
- [ ] Test workflow on feature branch
- [ ] Verify permissions are correct
- [ ] Confirm caching works

### Phase 2: GitHub Repository Configuration (1 hour)

- [ ] Enable GitHub Pages in repository settings
  - Navigate to Settings → Pages
  - Source: Deploy from branch `gh-pages`
  - Folder: `/` (root)
  - Custom domain: `docs.screener.kr`
  - Enforce HTTPS: ✓
- [ ] Configure branch protection for main
  - Require status checks to pass before merging
  - Add documentation build as required check
- [ ] Set up workflow permissions
  - Settings → Actions → General → Workflow permissions
  - Enable "Read and write permissions"

### Phase 3: DNS Configuration (30 min)

- [ ] Add CNAME record at domain provider:
  ```
  Type: CNAME
  Name: docs
  Value: kcenon.github.io
  TTL: 3600
  ```
- [ ] Create `docs-site/static/CNAME` file:
  ```
  docs.screener.kr
  ```
- [ ] Wait for DNS propagation (up to 24 hours)
- [ ] Verify domain resolves correctly:
  ```bash
  dig docs.screener.kr
  ```

### Phase 4: Build Optimization (1 hour)

- [ ] Enable dependency caching (npm, pip)
- [ ] Configure parallel builds where possible
- [ ] Add build time monitoring
- [ ] Optimize Docker layer caching (if used)
- [ ] Profile build to identify bottlenecks

### Phase 5: Monitoring & Badges (30 min)

- [ ] Add deployment status badges to README:
  ```markdown
  [![Documentation](https://img.shields.io/badge/docs-live-success)](https://docs.screener.kr)
  [![Deploy Docs](https://github.com/kcenon/screener_system/actions/workflows/docs.yml/badge.svg)](https://github.com/kcenon/screener_system/actions/workflows/docs.yml)
  ```
- [ ] Set up email notifications for failed deployments
- [ ] Configure GitHub Actions monitoring dashboard
- [ ] Test deployment rollback procedure

## Acceptance Criteria

- [ ] Documentation builds on every push to main branch
- [ ] Build completes in < 3 minutes
- [ ] Deployment to GitHub Pages succeeds automatically
- [ ] Documentation site accessible at `https://docs.screener.kr`
- [ ] HTTPS enabled with valid certificate
- [ ] Failed builds send notifications
- [ ] Deployment status visible in GitHub UI
- [ ] Build status badges added to README

## Verification Steps

```bash
# 1. Trigger workflow manually
gh workflow run docs.yml

# 2. Check workflow status
gh run list --workflow=docs.yml

# 3. View workflow logs
gh run view <run-id> --log

# 4. Verify deployment
curl -I https://docs.screener.kr
# Expected: HTTP/2 200

# 5. Check SSL certificate
curl -vI https://docs.screener.kr 2>&1 | grep "SSL certificate verify"
# Expected: OK

# 6. Verify GitHub Pages status
gh api repos/kcenon/screener_system/pages

# 7. Check deployment in GitHub UI
# Visit: https://github.com/kcenon/screener_system/deployments
```

## Troubleshooting Guide

### Build Failures

**Problem**: Sphinx build fails with import errors
- **Solution**: Verify Python dependencies in `requirements-docs.txt`
- **Check**: Ensure all backend modules are importable

**Problem**: TypeDoc build fails
- **Solution**: Check TypeScript compilation errors
- **Command**: `npx tsc --noEmit`

**Problem**: Docusaurus build fails
- **Solution**: Check for MDX syntax errors
- **Command**: `npm run build -- --debug`

### Deployment Issues

**Problem**: Deployment fails with permission error
- **Solution**: Check workflow has `contents: write` permission
- **Verify**: Settings → Actions → General → Workflow permissions

**Problem**: Custom domain not working
- **Solution**: Verify CNAME file in build output
- **Check**: `ls docs-site/build/CNAME`

**Problem**: SSL certificate not provisioned
- **Solution**: Wait 24 hours for GitHub to provision certificate
- **Verify**: Check "Enforce HTTPS" is enabled in Pages settings

## Performance Targets

| Metric | Target | How to Measure |
|--------|--------|----------------|
| **Total build time** | < 3 minutes | GitHub Actions duration |
| **Sphinx build** | < 30 seconds | Workflow step duration |
| **TypeDoc build** | < 20 seconds | Workflow step duration |
| **Docusaurus build** | < 90 seconds | Workflow step duration |
| **Deployment time** | < 30 seconds | peaceiris/actions-gh-pages duration |
| **Time to live** | < 5 minutes | Commit to docs.screener.kr update |

## Cost Analysis

| Component | Cost | Notes |
|-----------|------|-------|
| **GitHub Actions** | $0 | 2,000 minutes/month free for public repos |
| **GitHub Pages** | $0 | Unlimited bandwidth for public repos |
| **Storage** | $0 | Unlimited for documentation sites |
| **SSL Certificate** | $0 | Auto-managed by GitHub |
| **Total** | **$0/month** | Completely free for open source |

## Definition of Done

- [x] GitHub Actions workflow created and working
- [x] Documentation builds successfully
- [x] Automatic deployment to GitHub Pages configured
- [x] Custom domain configured with SSL
- [x] DNS records set up correctly
- [x] Build time < 3 minutes
- [x] Status badges added to README
- [x] Team notified of deployment process
- [x] Documentation updated with CI/CD info
- [x] PR reviewed and merged

## References

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [peaceiris/actions-gh-pages](https://github.com/peaceiris/actions-gh-pages)
- [GitHub Pages Documentation](https://docs.github.com/en/pages)
- [Docusaurus Deployment](https://docusaurus.io/docs/deployment#deploying-to-github-pages)
- [GitHub Actions Caching](https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows)
