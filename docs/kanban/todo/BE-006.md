# [BE-006] WebSocket Real-time Price Streaming

## Metadata
- **Status**: IN_PROGRESS
- **Priority**: High
- **Assignee**: AI Assistant
- **Estimated Time**: 16 hours (0h completed, 16h remaining)
- **Sprint**: Sprint 3 (Week 5-6)
- **Tags**: #backend #websocket #real-time #streaming
- **Created**: 2025-11-10
- **Moved to TODO**: 2025-11-10
- **Started**: 2025-11-10 20:00

## Description
Implement WebSocket server for real-time stock price streaming to frontend clients. Enable sub-100ms latency updates for better user experience compared to REST API polling.

## Subtasks
- [ ] WebSocket Server Implementation
  - [ ] FastAPI WebSocket endpoint
  - [ ] Connection management (connect, disconnect)
  - [ ] Heartbeat/ping-pong mechanism
  - [ ] Automatic reconnection handling
  - [ ] Connection pool management
- [ ] Room-based Subscription System
  - [ ] Subscribe to specific stock codes
  - [ ] Subscribe to market (KOSPI, KOSDAQ)
  - [ ] Subscribe to sector
  - [ ] Unsubscribe mechanism
  - [ ] Multiple subscriptions per connection
- [ ] Redis Pub/Sub Integration
  - [ ] Pub/Sub for multi-instance support
  - [ ] Message broadcasting
  - [ ] Channel naming convention
  - [ ] Message serialization (JSON)
- [ ] Data Publishing
  - [ ] Price update publisher
  - [ ] Order book update publisher
  - [ ] Market status events
  - [ ] Alert notifications
- [ ] Message Format
  - [ ] Event types (price_update, orderbook_update, alert, error)
  - [ ] Timestamp in all messages
  - [ ] Sequence number for ordering
  - [ ] JSON schema validation
- [ ] Authentication
  - [ ] JWT token in WebSocket handshake
  - [ ] Token validation on connect
  - [ ] Re-authentication on token expiry
  - [ ] Graceful connection closure
- [ ] Error Handling
  - [ ] Connection timeout (30 seconds idle)
  - [ ] Invalid message handling
  - [ ] Subscription errors
  - [ ] Automatic fallback to REST
- [ ] Performance Optimization
  - [ ] Message batching (10-50ms window)
  - [ ] Compression (per-message deflate)
  - [ ] Rate limiting per connection
  - [ ] Memory-efficient broadcast

## Acceptance Criteria
- [ ] **Connection Management**
  - [ ] Clients can connect via WebSocket
  - [ ] JWT authentication works
  - [ ] Heartbeat keeps connection alive
  - [ ] Graceful disconnect on client close
- [ ] **Subscription**
  - [ ] Subscribe to stock code (e.g., "005930")
  - [ ] Subscribe to multiple stocks
  - [ ] Unsubscribe works correctly
  - [ ] Only receive subscribed updates
- [ ] **Real-time Updates**
  - [ ] Price updates sent < 100ms after change
  - [ ] Order book updates in real-time
  - [ ] No message loss (99.9% delivery)
  - [ ] Messages arrive in correct order
- [ ] **Performance**
  - [ ] Supports 10,000 concurrent connections
  - [ ] Latency < 100ms (p99)
  - [ ] CPU usage < 50% at peak
  - [ ] Memory < 1GB for 10K connections
- [ ] **Reliability**
  - [ ] 99.9% uptime
  - [ ] Automatic reconnection works
  - [ ] Redis Pub/Sub handles multi-instance
  - [ ] No memory leaks (24+ hour stress test)
- [ ] **Testing**
  - [ ] Unit tests for message handling
  - [ ] Integration tests with Redis
  - [ ] Load testing (10K connections)
  - [ ] Reconnection scenarios tested

## Dependencies
- **Depends on**: BE-001, BE-003, DP-004, INFRA-001
- **Blocks**: FE-005, FE-006

## References
- **SDS.md**: Section 5.4 WebSocket Architecture (to be added)
- **SRS.md**: REQ-PERF-002 Real-time Updates (to be added)
- [FastAPI WebSocket](https://fastapi.tiangolo.com/advanced/websockets/)
- [Redis Pub/Sub](https://redis.io/topics/pubsub)

## Progress
- **0%** - Not started

## Notes
- WebSocket protocol allows bi-directional communication
- Use Server-Sent Events (SSE) as simpler alternative if WebSocket too complex
- Consider using socket.io library for easier client management
- Implement exponential backoff for reconnection attempts
- Monitor connection count and close idle connections
- Log all connection events for debugging
- Provide WebSocket testing tool/dashboard
