# [DB-002] Database Schema Migration Implementation

## Metadata
- **Status**: TODO
- **Priority**: Critical
- **Assignee**: TBD
- **Estimated Time**: 10 hours
- **Sprint**: Sprint 1 (Week 1)
- **Tags**: #database #schema #migration

## Description
Create the complete database schema for the Stock Screening Platform. Define all tables, constraints, and relationships, and implement them as migration scripts.

## Subtasks
- [ ] Create and execute 00_extensions.sql
  - [ ] CREATE EXTENSION timescaledb
  - [ ] CREATE EXTENSION pg_trgm
  - [ ] CREATE EXTENSION uuid-ossp
- [ ] Create and execute 01_create_tables.sql
  - [ ] Create stocks table
  - [ ] Create daily_prices table
  - [ ] Create financial_statements table
  - [ ] Create calculated_indicators table
  - [ ] Create users table
  - [ ] Create portfolios table
  - [ ] Create portfolio_holdings table
  - [ ] Create alerts table
  - [ ] Create watchlists table
  - [ ] Create watchlist_items table
  - [ ] Create saved_screens table
  - [ ] Create user_activity_log table
  - [ ] Create data_ingestion_log table
  - [ ] Create refresh_tokens table
- [ ] Create and execute 02_timescaledb_setup.sql
  - [ ] Convert daily_prices to hypertable
  - [ ] Set compression policy (after 365 days)
  - [ ] Set retention policy (10 years)
- [ ] Add table comments and column descriptions
- [ ] Verify foreign key constraints
- [ ] Verify check constraints
- [ ] Write migration execution script (run_migrations.sh)
- [ ] Write migration rollback script

## Acceptance Criteria
- [ ] All tables created successfully
- [ ] `SELECT tablename FROM pg_tables WHERE schemaname = 'public';` shows 14 tables
- [ ] `SELECT * FROM timescaledb_information.hypertables;` confirms daily_prices
- [ ] Foreign key relationships verified: `SELECT * FROM information_schema.table_constraints WHERE constraint_type = 'FOREIGN KEY';`
- [ ] Check constraints verified: `SELECT * FROM information_schema.check_constraints;`
- [ ] Sample data INSERT/UPDATE/DELETE tests succeed
- [ ] Constraint violations trigger appropriate errors

## Dependencies
- **Depends on**: DB-001
- **Blocks**: DB-003, BE-002, BE-003

## References
- **SRS.md**: Section 3.1 Functional Requirements
- **SDS.md**: Section 4.2 Table Schemas
- **database/migrations/01_create_tables.sql**
- **database/migrations/02_timescaledb_setup.sql**

## Progress
- **0%** - Not started

## Notes
- Execute migrations in order (00 → 01 → 02 → ...)
- daily_prices MUST be converted to hypertable (critical for performance)
- Compression initially manual, automate after stabilization
