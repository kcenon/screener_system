# [BE-002] User Authentication API Implementation

## Metadata
- **Status**: TODO
- **Priority**: Critical
- **Assignee**: TBD
- **Estimated Time**: 12 hours
- **Sprint**: Sprint 1 (Week 1-2)
- **Tags**: #backend #authentication #security

## Description
Implement JWT-based user authentication system including registration, login, token refresh, and logout functionality.

## Subtasks
- [ ] Database Models
  - [ ] app/db/models/user.py (User model)
  - [ ] app/db/models/refresh_token.py (RefreshToken model)
- [ ] Pydantic Schemas
  - [ ] app/schemas/user.py
    - [ ] UserCreate (email, password, name)
    - [ ] UserLogin (email, password)
    - [ ] UserResponse (id, email, name, tier)
    - [ ] TokenResponse (access_token, refresh_token, user)
- [ ] Repository Layer
  - [ ] app/repositories/user_repository.py
    - [ ] get_by_email()
    - [ ] get_by_id()
    - [ ] create()
    - [ ] update()
- [ ] Service Layer
  - [ ] app/services/auth_service.py
    - [ ] register_user()
    - [ ] authenticate_user()
    - [ ] create_tokens()
    - [ ] refresh_access_token()
    - [ ] revoke_refresh_token()
- [ ] API Endpoints
  - [ ] POST /v1/auth/register
  - [ ] POST /v1/auth/login
  - [ ] POST /v1/auth/refresh
  - [ ] POST /v1/auth/logout
  - [ ] GET /v1/users/me (current user information)
- [ ] Dependencies
  - [ ] app/api/dependencies.py
    - [ ] get_current_user() - JWT validation and user retrieval
    - [ ] get_current_active_user() - allow only active users
- [ ] Password security
  - [ ] bcrypt hashing (cost factor 12)
  - [ ] Password strength validation (minimum 8 characters)
- [ ] JWT token management
  - [ ] Access token (15 minute expiry)
  - [ ] Refresh token (30 day expiry)
  - [ ] Token blacklist (Redis)

## Acceptance Criteria
- [ ] **Registration Tests**
  - [ ] Registration succeeds with valid data (201 Created)
  - [ ] Duplicate email registration fails (409 Conflict)
  - [ ] Weak password rejected (400 Bad Request)
- [ ] **Login Tests**
  - [ ] Login succeeds with correct credentials (200 OK, returns tokens)
  - [ ] Login fails with incorrect password (401 Unauthorized)
  - [ ] Login fails with non-existent user (401 Unauthorized)
- [ ] **Token Validation Tests**
  - [ ] Protected endpoint accessible with valid access token
  - [ ] Expired access token rejected (401 Unauthorized)
  - [ ] Token with invalid signature rejected (401 Unauthorized)
- [ ] **Token Refresh Tests**
  - [ ] New access token issued with valid refresh token
  - [ ] Expired refresh token rejected (401 Unauthorized)
  - [ ] Logged-out refresh token rejected (401 Unauthorized)
- [ ] **Logout Tests**
  - [ ] Refresh token invalidated after logout
- [ ] **Rate Limiting Tests**
  - [ ] Login attempts blocked after 5 failures (429 Too Many Requests)

## Dependencies
- **Depends on**: BE-001, DB-002
- **Blocks**: FE-002, BE-003, BE-004

## References
- **SRS.md**: Section 3.1.1 User Authentication & Authorization (REQ-AUTH-001~008)
- **SDS.md**: Section 7.1 Authentication & Authorization
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)
- [JWT Best Practices](https://tools.ietf.org/html/rfc8725)

## Progress
- **0%** - Not started

## Notes
- Never store passwords in plain text
- Manage JWT secret key as environment variable (minimum 32 characters)
- Store refresh tokens in database (to support revocation)
- Defend against brute force attacks with rate limiting
