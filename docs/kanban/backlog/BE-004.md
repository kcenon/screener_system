# [BE-004] Stock Screening API Implementation

## Metadata
- **Status**: TODO
- **Priority**: Critical
- **Assignee**: TBD
- **Estimated Time**: 16 hours
- **Sprint**: Sprint 2 (Week 3-4)
- **Tags**: #backend #api #screening #core-feature

## Description
Implement the platform's core feature: stock screening API. Build complex filtering queries optimized with 200+ indicators.

## Subtasks
- [ ] Pydantic Schemas
  - [ ] app/schemas/screening.py
    - [ ] FilterRange (min, max)
    - [ ] ScreeningRequest (market, filters, sort_by, order, pagination)
    - [ ] ScreeningResponse (stocks, meta, query_time_ms)
- [ ] Repository Layer
  - [ ] app/repositories/screening_repository.py
    - [ ] screen_stocks(filters, sort, offset, limit)
    - [ ] Dynamic query builder for filters
    - [ ] Use stock_screening_view (materialized view)
- [ ] Service Layer
  - [ ] app/services/screening_service.py
    - [ ] execute_screening() - with caching
    - [ ] validate_filters() - allow only permitted filters
    - [ ] build_cache_key() - based on filter hash
- [ ] Dynamic Query Builder
  - [ ] Generate WHERE clause dynamically
  - [ ] Combine each filter with AND condition
  - [ ] Handle NULL values
  - [ ] SQL injection protection (parameterized queries)
- [ ] Caching Strategy
  - [ ] Cache key: `screening:{hash(filters)}:{page}`
  - [ ] TTL: 5 minutes
  - [ ] Cache invalidation: after indicator calculation
- [ ] API Endpoint
  - [ ] POST /v1/screen
    - [ ] Request body validation
    - [ ] Filter validation (allowed keys)
    - [ ] Pagination (page, per_page)
    - [ ] Sorting (sort_by, order)
- [ ] Performance Optimization
  - [ ] Use materialized view (stock_screening_view)
  - [ ] Index-only scans
  - [ ] EXPLAIN ANALYZE analysis
  - [ ] Query result caching
- [ ] Predefined Screening Templates
  - [ ] Dividend stocks template (dividend_yield > 3%, quality_score > 70)
  - [ ] Value stocks template (per < 15, pbr < 1.5)
  - [ ] Growth stocks template (revenue_growth_yoy > 20%)
  - [ ] Quality stocks template (quality_score > 80)

## Acceptance Criteria
- [ ] **Basic Screening Tests**
  - [ ] POST /v1/screen succeeds (200 OK)
  - [ ] Query without filters returns all stocks
  - [ ] Single filter applied (per < 15)
  - [ ] Multiple filters applied (per < 15 AND roe > 10)
  - [ ] Range filter (per: {min: 5, max: 15})
- [ ] **Sorting Tests**
  - [ ] sort_by market_cap DESC
  - [ ] sort_by per ASC
  - [ ] sort_by quality_score DESC
- [ ] **Pagination Tests**
  - [ ] page=1, per_page=50
  - [ ] No overlap between page=2 and page=1 results
  - [ ] Metadata accuracy (total, pages)
- [ ] **Filter Validation Tests**
  - [ ] Reject disallowed filters (400 Bad Request)
  - [ ] Reject invalid range (min > max)
  - [ ] Reject negative values (when applicable)
- [ ] **Performance Tests**
  - [ ] Complex query < 500ms (p99) â­ Core goal
  - [ ] Simple query < 200ms (p95)
  - [ ] Cache hit < 50ms
  - [ ] 100 concurrent requests processed successfully
- [ ] **Caching Tests**
  - [ ] Cache hit on second identical filter request
  - [ ] Cache miss on filter change
  - [ ] Recalculation after TTL expiry
- [ ] **Template Tests**
  - [ ] Each template executes and returns results
  - [ ] Template results consistency verified

## Dependencies
- **Depends on**: BE-001, BE-003, DB-003
- **Blocks**: FE-003 (Screener Page)

## References
- **SRS.md**: Section 3.1.3 Stock Screening (REQ-SCREEN-001~004)
- **SDS.md**: Section 5.2.3 Screening Endpoint
- **SDS.md**: Section 8.2 Caching Strategy
- **PRD.md**: Section 5.2.2 Stock Screening (core feature)

## Progress
- **0%** - Not started

## Notes
- **Performance is critical**: p99 < 500ms target
- MUST use materialized view (reduce JOIN cost)
- Query plan analysis required (EXPLAIN ANALYZE)
- Consider filter limit (maximum 10?)
- Consider async processing for complex filters
