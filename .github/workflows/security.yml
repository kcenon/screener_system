name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security scan every Monday at 9:00 AM KST (00:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: read
  security-events: write  # For uploading SARIF results

jobs:
  frontend-security:
    name: Frontend Security Audit (npm)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run npm audit
        working-directory: frontend
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate --json > npm-audit.json || true

      - name: Display audit results
        working-directory: frontend
        run: |
          if [ -f npm-audit.json ]; then
            echo "=== npm Audit Results ==="
            cat npm-audit.json | jq -r '.vulnerabilities | to_entries | .[] | "\(.value.severity): \(.key) - \(.value.via[0].title // .value.via[0])"' || cat npm-audit.json
          fi

      - name: Check for high/critical vulnerabilities
        working-directory: frontend
        run: |
          # Fail if high or critical vulnerabilities found
          HIGH_VULNS=$(cat npm-audit.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(cat npm-audit.json | jq '.metadata.vulnerabilities.critical // 0')

          echo "Critical vulnerabilities: $CRITICAL_VULNS"
          echo "High vulnerabilities: $HIGH_VULNS"

          if [ "$CRITICAL_VULNS" -gt 0 ] || [ "$HIGH_VULNS" -gt 0 ]; then
            echo "❌ Found $CRITICAL_VULNS critical and $HIGH_VULNS high severity vulnerabilities"
            exit 1
          else
            echo "✅ No high or critical vulnerabilities found"
          fi

      - name: Upload npm audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: frontend/npm-audit.json
          retention-days: 30

  backend-security:
    name: Backend Security Audit (Python)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit
        working-directory: backend
        run: |
          echo "Running pip-audit on backend dependencies..."
          pip-audit -r requirements.txt --desc --format json > pip-audit.json || true

      - name: Display audit results
        working-directory: backend
        run: |
          if [ -f pip-audit.json ]; then
            echo "=== pip-audit Results ==="
            cat pip-audit.json | jq -r '.dependencies[] | "\(.name) \(.version): \(.vulns[].id) - \(.vulns[].description[:100])"' || cat pip-audit.json
          fi

      - name: Check for vulnerabilities
        working-directory: backend
        run: |
          # Count vulnerabilities (excluding ecdsa which has no fix)
          TOTAL_VULNS=$(cat pip-audit.json | jq '[.dependencies[] | select(.name != "ecdsa") | .vulns[]] | length')

          echo "Total vulnerabilities (excluding ecdsa): $TOTAL_VULNS"

          if [ "$TOTAL_VULNS" -gt 0 ]; then
            echo "❌ Found $TOTAL_VULNS vulnerabilities in Python dependencies"
            echo "Note: ecdsa vulnerability is excluded (no fix available, documented in SECURITY_NOTES.md)"
            exit 1
          else
            echo "✅ No vulnerabilities found (ecdsa excluded as documented)"
          fi

      - name: Upload pip-audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-results
          path: backend/pip-audit.json
          retention-days: 30

  data-pipeline-security:
    name: Data Pipeline Security Audit (Python)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit
        working-directory: data_pipeline
        run: |
          if [ -f requirements.txt ]; then
            echo "Running pip-audit on data pipeline dependencies..."
            pip-audit -r requirements.txt --desc --format json > pip-audit.json || true

            # Count vulnerabilities
            TOTAL_VULNS=$(cat pip-audit.json | jq '[.dependencies[] | .vulns[]] | length' || echo "0")
            echo "Total vulnerabilities: $TOTAL_VULNS"

            if [ "$TOTAL_VULNS" -gt 0 ]; then
              echo "❌ Found $TOTAL_VULNS vulnerabilities in data pipeline dependencies"
              cat pip-audit.json | jq -r '.dependencies[] | "\(.name) \(.version): \(.vulns[].id)"'
              exit 1
            else
              echo "✅ No vulnerabilities found in data pipeline"
            fi
          else
            echo "⚠️ No requirements.txt found in data_pipeline directory"
          fi

      - name: Upload data pipeline audit results
        if: always() && hashFiles('data_pipeline/pip-audit.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: data-pipeline-audit-results
          path: data_pipeline/pip-audit.json
          retention-days: 30

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [frontend-security, backend-security, data-pipeline-security, secret-scanning]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate security summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Frontend
          if [ -f npm-audit-results/npm-audit.json ]; then
            echo "## Frontend (npm)" >> $GITHUB_STEP_SUMMARY
            CRITICAL=$(cat npm-audit-results/npm-audit.json | jq '.metadata.vulnerabilities.critical // 0')
            HIGH=$(cat npm-audit-results/npm-audit.json | jq '.metadata.vulnerabilities.high // 0')
            MODERATE=$(cat npm-audit-results/npm-audit.json | jq '.metadata.vulnerabilities.moderate // 0')
            LOW=$(cat npm-audit-results/npm-audit.json | jq '.metadata.vulnerabilities.low // 0')
            echo "- Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- Moderate: $MODERATE" >> $GITHUB_STEP_SUMMARY
            echo "- Low: $LOW" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Backend
          if [ -f pip-audit-results/pip-audit.json ]; then
            echo "## Backend (Python)" >> $GITHUB_STEP_SUMMARY
            TOTAL=$(cat pip-audit-results/pip-audit.json | jq '[.dependencies[] | .vulns[]] | length')
            echo "- Total vulnerabilities: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- Note: ecdsa timing attack excluded (no fix available)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Security: ${{ needs.frontend-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Security: ${{ needs.backend-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Data Pipeline Security: ${{ needs.data-pipeline-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Scanning: ${{ needs.secret-scanning.result }}" >> $GITHUB_STEP_SUMMARY
